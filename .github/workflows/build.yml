name: Build Releases

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.6.15
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Version for the release (e.g., 0.6.15)'
        required: false
        default: 'dev'

env:
  PYTHON_VERSION: '3.14'

permissions:
  contents: write  # Required to create releases

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
            arch: x64
            asset_ext: .zip
          - os: ubuntu-22.04
            platform: linux
            arch: x64
            asset_ext: .tar.gz
          - os: macos-15  # Apple Silicon (arm64)
            platform: macos
            arch: arm64
            asset_ext: .tar.gz
          - os: macos-15-intel  # Intel Mac (x64)
            platform: macos
            arch: x64
            asset_ext: .tar.gz

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Strip 'v' prefix for cleaner filenames (v0.6.16 -> 0.6.16)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            VERSION="${VERSION#v}"
          else
            VERSION="dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # Linux: Install system dependencies for PyQt6 and pycurl
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libegl1 \
            libgl1-mesa-glx \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0

      # macOS: Install curl with openssl for pycurl
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          # Install quietly, suppress "already installed" warnings
          brew install curl openssl@3 2>/dev/null || true
          echo "PYCURL_SSL_LIBRARY=openssl" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix openssl@3)/lib -L$(brew --prefix curl)/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix openssl@3)/include -I$(brew --prefix curl)/include" >> $GITHUB_ENV
          echo "PATH=$(brew --prefix curl)/bin:$PATH" >> $GITHUB_ENV

      # Install Python dependencies (platform-aware)
      - name: Install Python dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Install Python dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          # Install pycurl with openssl (use env vars, not deprecated --global-option)
          export PYCURL_SSL_LIBRARY=openssl
          pip install --no-cache-dir pycurl
          # Install other deps, skipping Windows-only packages
          pip install requests PyQt6 PyQt6-Qt6 PyQt6_sip pillow tqdm cryptography standard-imghdr certifi keyring markdown colorama psutil py7zr rarfile splitzip

      - name: Install Python dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          # Install pycurl with openssl from Homebrew
          PYCURL_SSL_LIBRARY=openssl \
          LDFLAGS="-L$(brew --prefix openssl@3)/lib -L$(brew --prefix curl)/lib" \
          CPPFLAGS="-I$(brew --prefix openssl@3)/include -I$(brew --prefix curl)/include" \
          pip install --no-cache-dir pycurl
          # Install other deps, skipping Windows-only packages
          pip install requests PyQt6 PyQt6-Qt6 PyQt6_sip pillow tqdm cryptography standard-imghdr certifi keyring markdown colorama psutil py7zr rarfile splitzip

      # Windows build
      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          echo Building BBDrop for Windows...
          if exist dist rmdir /s /q dist
          if exist build rmdir /s /q build
          pyinstaller bbdrop.spec --clean -y

          echo Copying assets to dist...
          xcopy /E /I /Y assets dist\assets
          xcopy /E /I /Y docs dist\docs
          copy LICENSE dist\
          copy README.md dist\

      # Linux/macOS build
      - name: Build (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Building BBDrop for ${{ runner.os }}..."
          rm -rf dist build
          pyinstaller bbdrop.spec --clean -y

          echo "Copying assets to dist..."
          cp -r assets dist/
          cp -r docs dist/
          cp LICENSE README.md dist/

      # Verify pycurl (Windows) - informational only, don't fail
      - name: Verify pycurl (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Checking for pycurl files..."
          $pyd = Get-ChildItem -Path dist -Recurse -Filter "pycurl*" -ErrorAction SilentlyContinue
          if ($pyd) { Write-Host "Found: $($pyd.FullName)" } else { Write-Host "Warning: pycurl.pyd not found" }
          $dlls = Get-ChildItem -Path dist -Recurse -Filter "*curl*.dll" -ErrorAction SilentlyContinue
          if ($dlls) { $dlls | ForEach-Object { Write-Host "Found: $($_.FullName)" } } else { Write-Host "Warning: libcurl DLLs not found" }

      # Verify pycurl (Unix) - informational only, don't fail
      - name: Verify pycurl (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "Checking for pycurl files..."
          find dist -name "pycurl*" -type f 2>/dev/null || echo "Warning: pycurl not found"
          find dist -name "*curl*" -type f 2>/dev/null || echo "Warning: libcurl not found"
          true  # Always succeed - this is informational only

      # Package Windows (portable zip)
      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $filename = "bbdrop-$version-${{ matrix.platform }}-${{ matrix.arch }}-portable"
          Rename-Item dist bbdrop
          Compress-Archive -Path bbdrop -DestinationPath "$filename.zip" -Force

      # Create Windows installer with Inno Setup
      - name: Create Inno Setup script
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $issContent = @"
          [Setup]
          AppName=BBDrop
          AppVersion=$version
          AppPublisher=BBDrop
          DefaultDirName={autopf}\BBDrop
          DefaultGroupName=BBDrop
          OutputDir=.
          OutputBaseFilename=bbdrop-$version-${{ matrix.platform }}-${{ matrix.arch }}-setup
          Compression=lzma2
          SolidCompression=yes
          ArchitecturesAllowed=x64compatible
          ArchitecturesInstallIn64BitMode=x64compatible

          [Files]
          Source: "bbdrop\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

          [Icons]
          Name: "{group}\BBDrop"; Filename: "{app}\bbdrop.exe"
          Name: "{autodesktop}\BBDrop"; Filename: "{app}\bbdrop.exe"; Tasks: desktopicon

          [Tasks]
          Name: "desktopicon"; Description: "Create desktop shortcut"; GroupDescription: "Additional icons:"

          [Run]
          Filename: "{app}\bbdrop.exe"; Description: "Launch BBDrop"; Flags: nowait postinstall skipifsilent
          "@
          $issContent | Out-File -FilePath "bbdrop.iss" -Encoding UTF8

      - name: Build Windows Installer (exe)
        if: runner.os == 'Windows'
        uses: Minionguyjpro/Inno-Setup-Action@v1.2.4
        with:
          path: bbdrop.iss

      # Create Windows MSI installer with WiX
      - name: Create WiX script
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          # WiX requires a GUID for the product - generate deterministically from version
          $guid = [guid]::NewGuid().ToString().ToUpper()

          $wxsContent = @"
          <?xml version="1.0" encoding="UTF-8"?>
          <Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
            <Product Id="*"
                     Name="BBDrop"
                     Language="1033"
                     Version="$version.0"
                     Manufacturer="BBDrop"
                     UpgradeCode="F8E7D6C5-B4A3-4210-9F8E-7D6C5B4A3210">
              <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />
              <MajorUpgrade DowngradeErrorMessage="A newer version is already installed." />
              <MediaTemplate EmbedCab="yes" />

              <Feature Id="ProductFeature" Title="BBDrop" Level="1">
                <ComponentGroupRef Id="HeatGenerated" />
                <ComponentRef Id="StartMenuShortcut" />
                <ComponentRef Id="DesktopShortcut" />
              </Feature>

              <Directory Id="TARGETDIR" Name="SourceDir">
                <Directory Id="ProgramFiles64Folder">
                  <Directory Id="INSTALLFOLDER" Name="BBDrop" />
                </Directory>
                <Directory Id="ProgramMenuFolder">
                  <Directory Id="ApplicationProgramsFolder" Name="BBDrop" />
                </Directory>
                <Directory Id="DesktopFolder" Name="Desktop" />
              </Directory>

              <DirectoryRef Id="ApplicationProgramsFolder">
                <Component Id="StartMenuShortcut" Guid="*">
                  <Shortcut Id="StartMenuShortcut"
                            Name="BBDrop"
                            Target="[INSTALLFOLDER]bbdrop.exe"
                            WorkingDirectory="INSTALLFOLDER" />
                  <RemoveFolder Id="RemoveStartMenuFolder" On="uninstall" />
                  <RegistryValue Root="HKCU" Key="Software\BBDrop" Name="installed" Type="integer" Value="1" KeyPath="yes" />
                </Component>
              </DirectoryRef>

              <DirectoryRef Id="DesktopFolder">
                <Component Id="DesktopShortcut" Guid="*">
                  <Shortcut Id="DesktopShortcut"
                            Name="BBDrop"
                            Target="[INSTALLFOLDER]bbdrop.exe"
                            WorkingDirectory="INSTALLFOLDER" />
                  <RegistryValue Root="HKCU" Key="Software\BBDrop" Name="desktop" Type="integer" Value="1" KeyPath="yes" />
                </Component>
              </DirectoryRef>
            </Product>
          </Wix>
          "@
          $wxsContent | Out-File -FilePath "bbdrop.wxs" -Encoding UTF8

      - name: Build Windows MSI
        if: runner.os == 'Windows'
        run: |
          choco install wixtoolset -y
          $env:PATH += ";C:\Program Files (x86)\WiX Toolset v3.14\bin"
          # Use HeatGenerated as the component group name, -arch x64 for 64-bit components
          heat dir bbdrop -cg HeatGenerated -dr INSTALLFOLDER -scom -sreg -srd -var var.SourceDir -gg -sfrag -arch x64 -out components.wxs
          candle -arch x64 -dSourceDir=bbdrop bbdrop.wxs components.wxs
          light -ext WixUIExtension -out "bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.msi" bbdrop.wixobj components.wixobj
        shell: pwsh

      # Package Unix (portable tarball)
      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          FILENAME="bbdrop-$VERSION-${{ matrix.platform }}-${{ matrix.arch }}-portable"
          mv dist bbdrop
          tar -czvf "$FILENAME.tar.gz" bbdrop

      # Create Linux packages (deb, rpm, AppImage)
      - name: Create Linux packages
        if: runner.os == 'Linux'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          ARCH="${{ matrix.arch }}"

          # Install fpm for deb/rpm creation
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install fpm

          # Create .deb package
          fpm -s dir -t deb \
            -n bbdrop \
            -v "$VERSION" \
            -a amd64 \
            --description "Professional image gallery uploader for imx.to" \
            --url "https://github.com/twwat/bbdrop" \
            --license "MIT" \
            --prefix /opt/bbdrop \
            --after-install <(echo '#!/bin/bash
              ln -sf /opt/bbdrop/bbdrop /usr/local/bin/bbdrop
              cat > /usr/share/applications/bbdrop.desktop << EOD
          [Desktop Entry]
          Name=BBDrop
          Exec=/opt/bbdrop/bbdrop --gui
          Icon=/opt/bbdrop/assets/bbdrop-main-icon.png
          Type=Application
          Categories=Utility;Network;
          EOD') \
            --after-remove <(echo '#!/bin/bash
              rm -f /usr/local/bin/bbdrop
              rm -f /usr/share/applications/bbdrop.desktop') \
            bbdrop/=/opt/bbdrop/

          mv *.deb "bbdrop-$VERSION-${{ matrix.platform }}-${{ matrix.arch }}.deb"

          # Create .rpm package
          fpm -s dir -t rpm \
            -n bbdrop \
            -v "$VERSION" \
            -a x86_64 \
            --description "Professional image gallery uploader for imx.to" \
            --url "https://github.com/twwat/bbdrop" \
            --license "MIT" \
            --prefix /opt/bbdrop \
            --after-install <(echo '#!/bin/bash
              ln -sf /opt/bbdrop/bbdrop /usr/local/bin/bbdrop
              cat > /usr/share/applications/bbdrop.desktop << EOD
          [Desktop Entry]
          Name=BBDrop
          Exec=/opt/bbdrop/bbdrop --gui
          Icon=/opt/bbdrop/assets/bbdrop-main-icon.png
          Type=Application
          Categories=Utility;Network;
          EOD') \
            --after-remove <(echo '#!/bin/bash
              rm -f /usr/local/bin/bbdrop
              rm -f /usr/share/applications/bbdrop.desktop') \
            bbdrop/=/opt/bbdrop/

          mv *.rpm "bbdrop-$VERSION-${{ matrix.platform }}-${{ matrix.arch }}.rpm"

          # Create AppImage
          sudo apt-get install -y libfuse2
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool

          # Create AppDir structure
          mkdir -p BBDrop.AppDir/usr/bin
          mkdir -p BBDrop.AppDir/usr/share/applications
          mkdir -p BBDrop.AppDir/usr/share/icons/hicolor/256x256/apps
          cp -r bbdrop/* BBDrop.AppDir/usr/bin/
          cp bbdrop/assets/bbdrop-main-icon.png BBDrop.AppDir/usr/share/icons/hicolor/256x256/apps/bbdrop.png
          cp bbdrop/assets/bbdrop-main-icon.png BBDrop.AppDir/bbdrop.png

          # Create desktop file (no leading spaces, single category)
          cat > BBDrop.AppDir/bbdrop.desktop << 'EOD'
          [Desktop Entry]
          Name=BBDrop
          Exec=bbdrop --gui
          Icon=bbdrop
          Type=Application
          Categories=Network;
          EOD
          # Remove leading spaces from heredoc
          sed -i 's/^          //' BBDrop.AppDir/bbdrop.desktop
          cp BBDrop.AppDir/bbdrop.desktop BBDrop.AppDir/usr/share/applications/

          # Create AppRun
          cat > BBDrop.AppDir/AppRun << 'EOD'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/bbdrop" "$@"
          EOD
          sed -i 's/^          //' BBDrop.AppDir/AppRun
          chmod +x BBDrop.AppDir/AppRun

          # Build AppImage
          ARCH=x86_64 ./appimagetool BBDrop.AppDir "bbdrop-$VERSION-${{ matrix.platform }}-${{ matrix.arch }}.AppImage"

      # Create macOS DMG
      - name: Create macOS DMG
        if: runner.os == 'macOS'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          FILENAME="bbdrop-$VERSION-${{ matrix.platform }}-${{ matrix.arch }}"

          # Install create-dmg
          brew install create-dmg

          # Create .app bundle structure
          mkdir -p BBDrop.app/Contents/MacOS
          mkdir -p BBDrop.app/Contents/Resources
          cp -r bbdrop/* BBDrop.app/Contents/MacOS/

          # Create Info.plist
          cat > BBDrop.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>bbdrop</string>
              <key>CFBundleIdentifier</key>
              <string>com.bbdrop.app</string>
              <key>CFBundleName</key>
              <string>BBDrop</string>
              <key>CFBundleVersion</key>
              <string>$VERSION</string>
              <key>CFBundleShortVersionString</key>
              <string>$VERSION</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Create DMG
          create-dmg \
            --volname "BBDrop $VERSION" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "BBDrop.app" 150 185 \
            --hide-extension "BBDrop.app" \
            --app-drop-link 450 185 \
            "$FILENAME.dmg" \
            "BBDrop.app" || true  # create-dmg returns non-zero even on success sometimes

      # Upload portable artifact
      - name: Upload portable artifact
        uses: actions/upload-artifact@v4
        with:
          name: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-portable
          path: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-portable${{ matrix.asset_ext }}
          retention-days: 30

      # Upload Windows installer (raw .exe, not zipped)
      - name: Upload Windows installer (exe)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-setup
          path: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-setup.exe
          compression-level: 0  # Don't compress the .exe
          retention-days: 30

      # Upload Windows MSI installer
      - name: Upload Windows installer (msi)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-msi
          path: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.msi
          retention-days: 30

      # Upload macOS DMG
      - name: Upload macOS DMG
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-dmg
          path: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.dmg
          compression-level: 0  # DMG is already compressed
          retention-days: 30

      # Upload Linux .deb
      - name: Upload Linux deb
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-deb
          path: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.deb
          retention-days: 30

      # Upload Linux .rpm
      - name: Upload Linux rpm
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-rpm
          path: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.rpm
          retention-days: 30

      # Upload Linux AppImage
      - name: Upload Linux AppImage
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}-appimage
          path: bbdrop-${{ steps.version.outputs.VERSION }}-${{ matrix.platform }}-${{ matrix.arch }}.AppImage
          retention-days: 30

  # Create release when triggered by tag
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: ls -la artifacts/*

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.zip
            artifacts/**/*.tar.gz
            artifacts/**/*.exe
            artifacts/**/*.msi
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
